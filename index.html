<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generator Nilai Siswa Pro (Excel Paste Fixed)</title>
    <style>
        :root { --primary: #2563eb; --secondary: #1e40af; --bg: #f8fafc; --border: #e2e8f0; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding: 20px; color: #334155; }
        .container { max-width: 1600px; margin: 0 auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid var(--border); padding-bottom: 15px; }
        h1 { margin: 0; color: var(--secondary); font-size: 22px; }
        .badge { background: #dbeafe; color: #1e40af; padding: 5px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; }
        .config-box { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; background: #f1f5f9; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .c-item label { display: block; font-size: 11px; font-weight: 700; color: #64748b; margin-bottom: 4px; text-transform: uppercase; }
        .c-item input { width: 100%; padding: 6px; border: 1px solid #cbd5e1; border-radius: 4px; font-size: 13px; box-sizing: border-box; }
        .mode-switch { display: flex; gap: 10px; align-items: center; background: white; padding: 4px; border-radius: 6px; border: 1px solid #cbd5e1; }
        .mode-opt { padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 13px; font-weight: 600; user-select: none; }
        .mode-opt.active { background: var(--primary); color: white; }
        .table-wrap { overflow-x: auto; border: 1px solid var(--border); border-radius: 6px; max-height: 70vh; }
        table { width: 100%; border-collapse: separate; border-spacing: 0; font-size: 13px; min-width: 1400px; }
        th { background: #1e293b; color: white; padding: 10px; font-weight: 600; border-right: 1px solid #334155; position: sticky; top: 0; z-index: 10; white-space: nowrap; }
        td { border-bottom: 1px solid var(--border); border-right: 1px solid var(--border); padding: 0; }
        
        /* PENTING: Input type text agar bisa terima format Excel Indonesia */
        input.cell { width: 100%; height: 36px; border: none; background: transparent; text-align: center; font-family: inherit; font-size: 13px; outline: none; padding: 0 5px; box-sizing: border-box; }
        input.cell:focus { box-shadow: inset 0 0 0 2px var(--primary); background: white; }
        input.cell.nm { text-align: left; padding-left: 8px; }
        .g-inp { background: #eff6ff; color: #1d4ed8; font-weight: 600; }
        .g-res { background: #f0fdf4; color: #15803d; font-weight: 600; }
        .actions { margin-top: 20px; display: flex; justify-content: flex-end; gap: 10px; }
        button { padding: 10px 20px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px; font-size: 14px; transition: 0.2s; }
        .btn-run { background: var(--primary); color: white; }
        .btn-xls { background: #10b981; color: white; }
        .btn-rst { background: #64748b; color: white; }
        .paste-hint { font-size: 12px; color: #ef4444; margin-top: 5px; font-style: italic; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <div>
            <div class="badge">üë®‚Äçüíª Created by Pebrianto</div>
            <h1>Generator Nilai Siswa Pro <span style="font-size: 14px; color: #64748b;">(Excel Fix)</span></h1>
            <div class="paste-hint">üí° Tips: Paste data Excel (Rumus/Nilai) di sel pertama. Format koma/titik didukung otomatis.</div>
        </div>
        <div class="mode-switch">
            <div class="mode-opt active" id="modeTarget" onclick="setMode('target')">üéØ Mode Target</div>
            <div class="mode-opt" id="modeFlow" onclick="setMode('flow')">üåä Mode Ranking</div>
        </div>
    </header>

    <div class="config-box">
        <div class="c-item"><label>Jml Nilai Harian</label><input type="number" id="confJumNH" value="4" min="1" max="6"></div>
        <div class="c-item"><label>Range NH</label><div style="display:flex; gap:5px"><input type="number" id="confMinNH" value="70"><input type="number" id="confMaxNH" value="95"></div></div>
        <div class="c-item"><label>Range Ujian</label><div style="display:flex; gap:5px"><input type="number" id="confMinUS" value="70"><input type="number" id="confMaxUS" value="95"></div></div>
        <div class="c-item"><label>Bobot (%)</label><div style="display:flex; gap:5px"><input type="number" id="confBobotNH" value="40"><input type="number" id="confBobotUS" value="60"></div></div>
    </div>

    <div class="table-wrap">
        <table id="mainTable">
            <thead>
                <tr>
                    <th rowspan="2" style="width:40px">No</th>
                    <th rowspan="2" style="width:250px; background:#0f172a">Nama Siswa</th>
                    <th colspan="3" style="background:#1e3a8a">INPUT DATA (Paste Disini)</th>
                    <th colspan="7" style="background:#c2410c">GENERATE NILAI HARIAN</th>
                    <th colspan="2" style="background:#14532d">HASIL AKHIR</th>
                </tr>
                <tr>
                    <th style="width:80px">NH Awal</th>
                    <th style="width:80px">US Awal</th>
                    <th style="width:80px">Target</th>
                    <th style="width:50px">NH1</th><th style="width:50px">NH2</th><th style="width:50px">NH3</th><th style="width:50px">NH4</th><th style="width:50px">NH5</th><th style="width:50px">NH6</th>
                    <th style="width:60px">Rata2</th>
                    <th style="width:80px">N.Ujian</th><th style="width:80px">Akhir</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>

    <div class="actions">
        <button class="btn-rst" onclick="resetTable()">‚Üª Reset</button>
        <button class="btn-run" onclick="generate()">‚ö° Generate Nilai</button>
        <button class="btn-xls" onclick="exportExcel()">üì• Download Excel</button>
    </div>
</div>

<script>
    let currentMode = 'target';
    const TOTAL_ROWS = 40;

    window.onload = function() {
        renderRows(TOTAL_ROWS);
        setupPasteHandler();
    };

    function setMode(mode) {
        currentMode = mode;
        document.getElementById('modeTarget').className = mode === 'target' ? 'mode-opt active' : 'mode-opt';
        document.getElementById('modeFlow').className = mode === 'flow' ? 'mode-opt active' : 'mode-opt';
        const inputs = document.querySelectorAll('.inp-target');
        inputs.forEach(inp => {
            if(mode === 'flow') { inp.style.opacity = '0.3'; inp.disabled = true; inp.value = '-'; } 
            else { inp.style.opacity = '1'; inp.disabled = false; if(inp.value === '-') inp.value = ''; }
        });
    }

    function renderRows(n) {
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = '';
        for(let i=1; i<=n; i++) {
            // Perhatikan: type="text" pada input angka agar fleksibel menerima paste excel
            tbody.innerHTML += `
            <tr>
                <td>${i}</td>
                <td><input class="cell nm" type="text" placeholder="Siswa ${i}"></td>
                <td><input class="cell g-inp inp-nh" type="text" placeholder="0"></td>
                <td><input class="cell g-inp inp-us" type="text" placeholder="0"></td>
                <td><input class="cell g-inp inp-target" type="text" placeholder="85"></td>
                
                <td><input class="cell g-mid res-nh1" readonly tabindex="-1"></td>
                <td><input class="cell g-mid res-nh2" readonly tabindex="-1"></td>
                <td><input class="cell g-mid res-nh3" readonly tabindex="-1"></td>
                <td><input class="cell g-mid res-nh4" readonly tabindex="-1"></td>
                <td><input class="cell g-mid res-nh5" readonly tabindex="-1"></td>
                <td><input class="cell g-mid res-nh6" readonly tabindex="-1"></td>
                <td><input class="cell g-mid res-avg" style="font-weight:bold" readonly tabindex="-1"></td>
                <td><input class="cell g-res res-final-us" readonly tabindex="-1"></td>
                <td><input class="cell g-res res-final" readonly tabindex="-1"></td>
            </tr>`;
        }
    }

    // --- PASTE HANDLER (Simple & Robust) ---
    function setupPasteHandler() {
        document.addEventListener('paste', function(e) {
            if (!e.target.classList.contains('cell')) return;
            e.preventDefault();
            
            // Ambil text plain apa adanya
            const clipboardData = e.clipboardData || window.clipboardData;
            const pastedData = clipboardData.getData('text/plain');
            const rows = pastedData.split(/\r\n|\n|\r/).filter(row => row.trim() !== '');

            const allRows = Array.from(document.querySelectorAll('#tableBody tr'));
            const currentRow = e.target.closest('tr');
            const startRowIdx = allRows.indexOf(currentRow);
            
            let startColType = -1;
            if (e.target.classList.contains('nm')) startColType = 0;
            else if (e.target.classList.contains('inp-nh')) startColType = 1;
            else if (e.target.classList.contains('inp-us')) startColType = 2;
            else if (e.target.classList.contains('inp-target')) startColType = 3;

            if (startRowIdx === -1 || startColType === -1) return;

            rows.forEach((rowData, rOffset) => {
                const targetRowIdx = startRowIdx + rOffset;
                if (targetRowIdx < allRows.length) {
                    const tr = allRows[targetRowIdx];
                    const cols = rowData.split('\t');
                    
                    cols.forEach((val, cOffset) => {
                        const targetColType = startColType + cOffset;
                        let input = null;
                        if (targetColType === 0) input = tr.querySelector('.nm');
                        else if (targetColType === 1) input = tr.querySelector('.inp-nh');
                        else if (targetColType === 2) input = tr.querySelector('.inp-us');
                        else if (targetColType === 3) input = tr.querySelector('.inp-target');

                        if (input) {
                            // Terima apa adanya dulu, nanti dibersihkan saat Generate
                            // Hapus tanda kutip excel
                            input.value = val.trim().replace(/^"|"$/g, '');
                            input.style.backgroundColor = '#dcfce7';
                            setTimeout(() => input.style.backgroundColor = '', 300);
                        }
                    });
                }
            });
        });
    }

    // --- HELPER: BACA ANGKA INDONESIA ---
    function parseIndoNum(val) {
        if (!val) return NaN;
        // Ubah koma jadi titik, hapus karakter non-angka/titik/minus
        let clean = val.toString().replace(',', '.').replace(/[^0-9.-]/g, '');
        return parseFloat(clean);
    }

    // --- GENERATE ---
    function mapVal(val, inMin, inMax, outMin, outMax) {
        if (inMax === inMin) return outMax;
        return outMin + ((val - inMin) * (outMax - outMin) / (inMax - inMin));
    }

        // --- GENERATE (Versi Nilai Bulat) ---
    function generate() {
        const jumNH = parseInt(document.getElementById('confJumNH').value);
        const minNH = parseFloat(document.getElementById('confMinNH').value);
        const maxNH = parseFloat(document.getElementById('confMaxNH').value);
        const minUS = parseFloat(document.getElementById('confMinUS').value);
        const maxUS = parseFloat(document.getElementById('confMaxUS').value);
        const bobotNH = parseFloat(document.getElementById('confBobotNH').value) / 100;
        const bobotUS = parseFloat(document.getElementById('confBobotUS').value) / 100;

        const rows = Array.from(document.querySelectorAll('#tableBody tr'));

        // 1. Analisis Nilai Global (Ranking)
        let arrNH = [], arrUS = [];
        rows.forEach(r => {
            let n = parseIndoNum(r.querySelector('.inp-nh').value);
            let u = parseIndoNum(r.querySelector('.inp-us').value);
            if(!isNaN(n)) arrNH.push(n);
            if(!isNaN(u)) arrUS.push(u);
        });

        if(arrNH.length === 0) { alert("Data kosong!"); return; }

        const gMinNH = Math.min(...arrNH), gMaxNH = Math.max(...arrNH);
        const gMinUS = Math.min(...arrUS), gMaxUS = Math.max(...arrUS);

        // 2. Proses Data
        rows.forEach(r => {
            const inpNH = parseIndoNum(r.querySelector('.inp-nh').value);
            const inpUS = parseIndoNum(r.querySelector('.inp-us').value);
            const inpTarget = parseIndoNum(r.querySelector('.inp-target').value);

            // Validasi
            if (isNaN(inpNH) || isNaN(inpUS)) {
                for(let k=1; k<=6; k++) r.querySelector(`.res-nh${k}`).value = '';
                r.querySelector('.res-avg').value = '';
                r.querySelector('.res-final-us').value = '';
                r.querySelector('.res-final').value = '';
                return;
            }

            // A. Generate NH
            let idealAvg = mapVal(inpNH, gMinNH, gMaxNH, minNH, maxNH);
            let vals = [], sum = 0;
            
            for(let i=0; i<jumNH-1; i++) {
                let v = Math.round(idealAvg + (Math.random()*6 - 3)); 
                v = Math.min(Math.max(v, minNH), maxNH);
                vals.push(v); sum += v;
            }
            
            // Penyeimbang agar rata-rata mendekati ideal
            let last = Math.round((idealAvg * jumNH) - sum);
            last = Math.min(Math.max(last, minNH), maxNH);
            vals.push(last);
            
            // Hitung Rata-rata (Tapi tetap simpan desimal dulu utk perhitungan akurat)
            let actAvg = vals.reduce((a,b)=>a+b,0) / jumNH;

            // B. Hitung Ujian
            let finalUS = 0;
            if (currentMode === 'target' && !isNaN(inpTarget)) {
                // Reverse calculation
                let req = (inpTarget - (actAvg * bobotNH)) / bobotUS;
                finalUS = Math.round(req);
                finalUS = Math.min(Math.max(finalUS, minUS), maxUS);
            } else {
                // Flow calculation
                finalUS = Math.round(mapVal(inpUS, gMinUS, gMaxUS, minUS, maxUS));
            }

            // C. Hitung Akhir & BULATKAN
            // Kita gunakan Math.round() untuk Nilai Akhir
            let finalScoreRaw = (actAvg * bobotNH) + (finalUS * bobotUS);
            let finalScore = Math.round(finalScoreRaw); 

            // --- RENDER HASIL ---
            for(let k=1; k<=6; k++) {
                // Nilai harian per butir sudah bulat dari proses di atas
                r.querySelector(`.res-nh${k}`).value = vals[k-1] !== undefined ? vals[k-1] : '-';
            }
            
            // Rata-rata boleh desimal atau mau dibulatkan juga?
            // Biasanya rata-rata NH di raport boleh desimal (misal 80.5), tapi Nilai Akhir harus bulat.
            // Jika Rata-rata NH harus bulat juga, ganti actAvg.toFixed(1) menjadi Math.round(actAvg)
            r.querySelector('.res-avg').value = actAvg.toFixed(1); // Tetap desimal untuk info
            
            r.querySelector('.res-final-us').value = finalUS; // Sudah bulat
            r.querySelector('.res-final').value = finalScore; // Sekarang Bulat (tanpa koma)
        });

        alert("Generate Selesai (Nilai Akhir Dibulatkan)!");
    }

    function resetTable() { if(confirm("Reset?")) renderRows(TOTAL_ROWS); }
    function exportExcel() {
        let table = document.getElementById("mainTable");
        let rows = table.querySelectorAll("tr");
        let csv = [];
        for (let i = 0; i < rows.length; i++) {
            let row = [], cols = rows[i].querySelectorAll("td, th");
            for (let j = 0; j < cols.length; j++) {
                let val = cols[j].innerText;
                let input = cols[j].querySelector("input");
                if (input) val = input.value;
                row.push(val);
            }
            csv.push(row.join("\t"));
        }
        let a = document.createElement('a');
        a.href = 'data:application/vnd.ms-excel,' + encodeURIComponent(csv.join("\n"));
        a.download = 'Hasil_Generate.xls';
        a.click();
    }
</script>

</body>
</html>
